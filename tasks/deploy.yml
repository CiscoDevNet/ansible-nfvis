---
- name: Writing debug payload
  copy:
    content: "{{ lookup('template', 'deploy.j2') }}"
    dest: "/tmp/{{ nfvis.host }}_{{ inventory_hostname }}.xml"
#  delegate_to: localhost

- name: Add deployments
  uri:
    url: "https://{{ nfvis.host }}/api/config/vm_lifecycle/tenants/tenant/admin/deployments"
    user: "{{ nfvis_username }}"
    password: "{{ nfvis_password }}"
    method: POST
    headers:
      Content-Type: "application/vnd.yang.data+xml"
    body: "{{ lookup('template', 'deploy.j2') }}"
    status_code: [ 200,201 ]
    return_content: yes
    validate_certs: no
  failed_when: uri_results.status not in [201, 409]
  changed_when: uri_results.status == 201
  no_log: false  # Don't show output as your password will be on the URI string
  register: uri_results
#  delegate_to: localhost

#- debug:
#    var: uri_results

# We can only deploy and undeploy.  Not modify
#- name: Modify deployments
#  uri:
#    url: "https://{{ ansible_host }}/api/config/deployments/network/{{ network }}"
#    user: "{{ nfvis_username }}"
#    password: "{{ nfvis_password }}"
#    method: PUT
#    headers:
#      Content-Type: "application/vnd.yang.data+xml"
#    body: "{{ lookup('template', 'network.j2') }}"
#    status_code: [ 200,201,204 ]
#    return_content: yes
#    validate_certs: no
#  no_log: false  # Don't show output as your password will be on the URI string
#  register: uri_results
##  failed_when: false
##  when: payload | length
#  loop: "{{ change_deployments | default([]) }}"
#  loop_control:
#    loop_var: network
#

